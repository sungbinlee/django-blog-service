{% extends 'base.html' %}

{% block content %}
  {% if post.tags.all %}
    <div class="mb-3">
      <strong>태그:</strong>
      {% for tag in post.tags.all %}
        <span class="badge bg-primary">{{ tag.name }}</span>
      {% endfor %}
    </div>
  {% endif %}
  <h1 class="mb-4">{{ post.title }}</h1>
  <p>{{ post.content }}</p>
  <p>작성자:
    {{ post.author }}</p>
  <p>카테고리:
    {{ post.category }}</p>
  <p>작성일시:
    {{ post.created_at }}</p>
  <p>수정일시:
    {{ post.updated_at }}</p>
  <p>조회수:
    {{ post.views }}</p>

  {% if post.images.all %}
    <h2>이미지</h2>
    <div class="post-images">
      {% for image in post.images.all %}
        <img src="{{ image.file_path.url }}" alt="{{ image.file_path }}" class="post-image img-thumbnail">
      {% endfor %}
    </div>
  {% endif %}

  {% if post.author == request.user %}
    <a href="{% url 'blog:post_update' post_id=post.id %}" class="btn btn-primary">수정</a>
    <a href="{% url 'blog:post_delete' post_id=post.id %}" class="btn btn-danger">삭제</a>
  {% endif %}

  <!-- 게시글 좋아요 -->
  <!-- ... (rest of the like button code) ... -->

  <h2 class="mt-4">댓글</h2>
  <!-- 최상위 댓글 작성 폼 -->
  {% if user.is_authenticated %}
    <form method="post" action="{% url 'blog:create_comment' post_id=post.id %}">
      {% csrf_token %}
      {{ comment_form.as_p }}
      <button type="submit" class="btn btn-primary">댓글 작성</button>
    </form>
  {% else %}
    <!-- 로그인을 유도하는 메시지 표시 -->
    <p class="mt-3">댓글을 작성하려면
      <a href="{% url 'user:login' %}">로그인</a>이 필요합니다.</p>
  {% endif %}

  {% for comment in post.comment_set.all %}
    {% if not comment.parent_comment %}
      <!-- 댓글 내용 -->
      <div class="comment mt-3">
        <p>{{ comment.content }}</p>
        <p>작성자:
          {{ comment.author }}</p>
        <p>작성일시:
          {{ comment.created_at }}</p>
        <!-- 댓글 좋아요 -->
        <!-- ... (rest of the like button code for comments) ... -->

        {% if user.is_authenticated %}
          {% if comment.author == user %}
            <!-- 로그인한 사용자가 작성한 댓글에 대해서만 수정 버튼 표시 -->
            <button class="btn btn-primary mt-2" onclick="toggleEditForm({{ comment.id }})">수정</button>
            <form id="edit-form-{{ comment.id }}" method="post" action="{% url 'blog:update_comment' comment_id=comment.id %}" style="display: none;">
              {% csrf_token %}
              {{ comment_form.as_p }}
              <button type="submit" class="btn btn-primary">수정</button>
            </form>
          {% endif %}

          <!-- 대댓글 작성 폼 -->
          <button class="btn btn-primary mt-2" onclick="toggleReplyForm({{ comment.id }})">대댓글 작성</button>
          <form id="reply-form-{{ comment.id }}" method="post" action="{% url 'blog:create_comment' post_id=post.id %}" style="display: none;">
            {% csrf_token %}
            {{ comment_form.as_p }}
            <input type="hidden" name="parent_comment_id" value="{{ comment.id }}">
            <button type="submit" class="btn btn-primary">Reply</button>
          </form>
        {% endif %}
        {% for reply in comment.comment_set.all %}
          {% if reply.parent_comment %}
            <!-- Only display direct replies -->
            <div class="ml-4 comment bg-light p-3">
              <p>Reply:
                {{ reply.content }}</p>
              <p>작성자:
                {{ reply.author }}</p>
              <p>작성일시:
                {{ reply.created_at }}</p>
              <!-- 댓글 좋아요 -->
              <!-- ... (rest of the like button code for comments) ... -->

              {% if user.is_authenticated %}
                {% if reply.author == user %}
                  <!-- 로그인한 사용자가 작성한 대댓글에 대해서만 수정 버튼 표시 -->
                  <button class="btn btn-primary mt-2" onclick="toggleEditForm({{ reply.id }})">수정</button>
                  <form id="edit-form-{{ reply.id }}" method="post" action="{% url 'blog:update_comment' comment_id=reply.id %}" style="display: none;">
                    {% csrf_token %}
                    {{ comment_form.as_p }}
                    <button type="submit" class="btn btn-primary">수정</button>
                  </form>
                {% endif %}
              {% endif %}
            </div>
          {% endif %}
        {% endfor %}
      </div>
    {% endif %}
  {% endfor %}

  <script>
    function toggleEditForm(commentId) {
      const form = document.getElementById(`edit-form-${commentId}`);
      form.style.display = form.style.display === "none"
        ? "block"
        : "none";
    }

    function toggleReplyForm(commentId) {
      const form = document.getElementById(`reply-form-${commentId}`);
      form.style.display = form.style.display === "none"
        ? "block"
        : "none";
    }
  </script>
{% endblock %}
